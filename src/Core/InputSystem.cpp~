#include "InputSystem.h"

namespace InputSystem {
    bool mouse_captured = true;

    void process_input(GLFWwindow* window, Camera& camera, float delta_time) {
        auto* app = static_cast<GLFW_Window::AppWindow*>(glfwGetWindowUserPointer(window));
        if (!app || !app->camera_ptr) return;

        float velocity = camera.movement_speed * delta_time;
        if (glfwGetKey(window, GLFW_KEY_W) == GLFW_PRESS)
            camera.position += camera.front * velocity;
        if (glfwGetKey(window, GLFW_KEY_A) == GLFW_PRESS)
            camera.position -= camera.right * velocity;
        if (glfwGetKey(window, GLFW_KEY_S) == GLFW_PRESS)
            camera.position -= camera.front * velocity;
        if (glfwGetKey(window, GLFW_KEY_D) == GLFW_PRESS)
            camera.position += camera.right * velocity;
        if (glfwGetKey(window, GLFW_KEY_SPACE) == GLFW_PRESS)
            camera.position += camera.up * velocity;
        if (glfwGetKey(window, GLFW_KEY_LEFT_CONTROL) == GLFW_PRESS)
            camera.position -= camera.up * velocity;
        if (glfwGetKey(window, GLFW_KEY_ESCAPE) == GLFW_PRESS && mouse_captured) {
            app->set_mouse_capture(false);
        }
    }

    void mouse_callback(GLFWwindow* window, double xpos, double ypos) {
        static bool first_mouse = true;
        static float last_x = 800.0f / 2;
        static float last_y = 600.0f / 2;

        auto* app = static_cast<AppWindow*>(glfwGetWindowUserPointer(window));
        if (!app || !app->camera_ptr) return;

        Camera& camera = *app->camera_ptr;

        if (first_mouse) {
            last_x = xpos;
            last_y = ypos;
            first_mouse = false;
        }

        float xoffset = xpos - last_x;
        float yoffset = last_y - ypos;  // Reversed since y-coordinates go bottom-to-top
        last_x = xpos;
        last_y = ypos;

        xoffset *= camera.mouse_sensitivity;
        yoffset *= camera.mouse_sensitivity;

        camera.yaw += xoffset;
        camera.pitch += yoffset;

        if (camera.pitch > 89.0f) camera.pitch = 89.0f;
        if (camera.pitch < -89.0f) camera.pitch = -89.0f;

        camera.update_vectors();

        if (glfwGetMouseButton(window, GLFW_MOUSE_BUTTON_LEFT) == GLFW_PRESS) {
			app->set_mouse_capture(true);
		}
    }
}